import { Injectable } from '@angular/core';
import { FormGroup } from '@angular/forms';
import jsPDF from 'jspdf';
import { StateService } from './state.service';
import { DataService } from './data/data.service';
import { FirmadigitalService } from './firmadigital.service';
import { HttpClient, HttpErrorResponse, HttpHeaders } from '@angular/common/http';

@Injectable({
  providedIn: 'root'
})
export class DenunciaService {

  // Contenido para registro de Denuncia
  private _seedDenunciado: string = '';
  public get seedDenunciado(): string {
    return this._seedDenunciado;
  }
  public set seedDenunciado(value: string) {
    this._seedDenunciado = value;
  }
  private _agenteRecepcion: string = '';
  public get agenteId(): string {
    return this._agenteRecepcion;
  }
  public set agenteId(value: string) {
    this._agenteRecepcion = value;
  }
  private _relacionAcusado: string = '';
  public get relacionAcusado(): string {
    return this._relacionAcusado;
  }
  public set relacionAcusado(value: string) {
    this._relacionAcusado = value;
  }
  private _tiempoDenuncia: string = '';
  public get tiempoDenuncia(): string {
    return this._tiempoDenuncia;
  }
  public set tiempoDenuncia(value: string) {
    this._tiempoDenuncia = value;
  }
  private _fechaDenuncia: string = '';
  public get fechaDenuncia(): string {
    return this._fechaDenuncia;
  }
  public set fechaDenuncia(value: string) {
    this._fechaDenuncia = value;
  }
  private _locacionDenuncia: string = '';
  public get locacionDenuncia(): string {
    return this._locacionDenuncia;
  }
  public set locacionDenuncia(value: string) {
    this._locacionDenuncia = value;
  }
  private _croquisDenuncia: string = '';
  public get croquisDenuncia(): string {
    return this._croquisDenuncia;
  }
  public set croquisDenuncia(value: string) {
    this._croquisDenuncia = value;
  }
  private _hechoDenuncia: string = '';
  public get hechoDenuncia(): string {
    return this._hechoDenuncia;
  }
  public set hechoDenuncia(value: string) {
    this._hechoDenuncia = value;
  }
  private _isReportes: boolean = false;
  public get isReportes(): boolean {
    return this._isReportes;
  }
  public set isReportes(value: boolean) {
    this._isReportes = value;
  }
  private _evidenciaDenuncia: string = '';
  public get evidenciaDenuncia(): string {
    return this._evidenciaDenuncia;
  }
  public set evidenciaDenuncia(value: string) {
    this._evidenciaDenuncia = value;
  }
  private _adicionalDenuncia: string = '';
  public get adicionalDenuncia(): string {
    return this._adicionalDenuncia;
  }
  public set adicionalDenuncia(value: string) {
    this._adicionalDenuncia = value;
  }
  private _instruccionesDenuncia: string = '';
  public get instruccionesDenuncia(): string {
    return this._instruccionesDenuncia;
  }
  public set instruccionesDenuncia(value: string) {
    this._instruccionesDenuncia = value;
  }

  private url = "http://ec2-54-157-168-45.compute-1.amazonaws.com/api/v1"

  constructor(private http: HttpClient,private state: StateService, private data: DataService, private firmadigital : FirmadigitalService) { }
  async generarPDF(fgDenunciante: FormGroup, fgDenunciado: FormGroup, fgParentesco: FormGroup, fgHecho: FormGroup, fgAdicional: FormGroup) {
    var linea = 10;
    const doc = new jsPDF();

    // Obtén la información de los formularios
    const dataDenunciante = fgDenunciante.value;
    const ahora = new Date();
    const fecha = ahora.toLocaleDateString();
    const nameFile = dataDenunciante["firstName"]+'_'+dataDenunciante["lastName"]+'_'+fecha
    console.log(dataDenunciante)
    const dataDenunciado = fgDenunciado.value;
    const dataParentesco = fgParentesco.value;
    const dataHecho = fgHecho.value;
    const dataAdicional = fgAdicional.value;

    var margen = 10; // Margen en milímetros
    var maxWidth = doc.internal.pageSize.width - margen * 2; // Ancho de la página menos los márgenes izquierdo y derecho
    
    // Agregar texto al PDF con ajuste automático
    //doc.text(textoLargo, margen, 20, { maxWidth: maxWidth });
    
    doc.text(`Registro Verbal de Incidente`,10,10,{align:'center'})
    // Agrega contenido al PDF
    doc.text(`Datos del formulario Denunciante:`, 10, 20);
    doc.text(`Dependencia policial`+ dataDenunciante["dependencianame"], margen, 30, { maxWidth: maxWidth });
    doc.text(`Departamento `+ dataDenunciante["dependenciadepartamento"] + ` Provincia `+dataDenunciante["dependenciaprovincia"]+` Distrito `+dataDenunciante["dependenciadistrito"], margen, 40, { maxWidth: maxWidth });
    this.firmadigital.generateImage().then((imageData) => {
      console.log("entrando a generar imagen")
      // Agregar imagen al PDF
      // Asegúrate de pasar las dimensiones correctas y el formato de la imagen (en este caso 'PNG')
      doc.addImage(imageData, 'PNG', 10, 60, 180, 90);


    }).catch(error => {
      console.error('Error al generar la imagen:', error);
    });
    doc.addPage()
    var y = 20;
    for (const key in dataDenunciante) {
      doc.text(`${key}: ${dataDenunciante[key]}`, 10, y);
      y += 10;
    }
    doc.addPage();

    doc.text(`Datos del formulario Denunciado:`, 10, 10);
    y = 20;
    for (const key in dataDenunciado) {
      doc.text(`${key}: ${dataDenunciado[key]}`, 10, y);
      y += 10;
    }

    doc.addPage();
    doc.text(`Datos del formulario Parentesco:`, 10, 10);
    y = 20;
    for (const key in dataParentesco) {
      doc.text(`${key}: ${dataParentesco[key]}`, 10, y);
      y += 10;
    }

    doc.addPage();
    doc.text(`Datos del formulario Hecho:`, 10, 10);
    y = 20;
    for (const key in dataHecho) {
      var texto = `${key}: ${dataHecho[key]}`;
      const splitText = doc.splitTextToSize(texto, maxWidth); // Divide el texto
      doc.text(splitText, 10, y); // Este método puede manejar array de strings (splitText)
      y += 10;
    }


    doc.addPage();
    doc.text(`Datos del formulario Adicional:`, 10, 10);
    y = 20;
    for (const key in dataAdicional) {
      var texto = `${key}: ${dataAdicional[key]}`;
      const splitText = doc.splitTextToSize(texto, maxWidth); // Divide el texto
      doc.text(splitText, 10, y); // Este método puede manejar array de strings (splitText)
      y += 15;
    }
    // Guarda el PDF
    const pdfBlob = doc.output('blob'); // Genera un Blob del PDF
    doc.save(nameFile+'.pdf');


    // Registrar en la Base de Datos
    await this.registrarDB(fgDenunciante, fgDenunciado, fgParentesco, fgHecho, fgAdicional)
    setTimeout(() => {
      this.data.enviarPDF(pdfBlob,this.state.idReporte)  
    }, 1500);
    
  }
  
  async registrarDB(fgDenunciante: FormGroup, fgDenunciado: FormGroup, fgParentesco: FormGroup, fgHecho: FormGroup, fgAdicional: FormGroup){
    console.log("Registrar DB y Enviar Denuncia")
    const dataDenunciante = fgDenunciante.value;            
    const dataDenunciado = fgDenunciado.value;
    const dataParentesco = fgParentesco.value;
    const dataHecho = fgHecho.value;
    const dataAdicional = fgAdicional.value;
    var data={
      "complainantId": dataDenunciado["denunciadoID"],
      "denouncedId": dataDenunciante["denuncianteID"],
      "relationshipDegree":dataParentesco["parentesco"],
      "timeOfIncident": dataHecho["tiempo"],
      "dateOfIncident": dataHecho["tiempo"],
      "locationDescription": dataAdicional["croquis"],
      "croquisUrl": dataAdicional["croquis"],
      "descriptionOfIncident": dataHecho["hecho"],
      "reportedToOtherAuthority": true,
      "evidenceProvided": "fotos, videos",
      "additionalInformation": dataAdicional["adicional"],
      "receivingAgentId": this.state.agente["id"],
      "urgentInstructions": "Handle with care"
    }
    await this.data.sendDenuncia(data)
  }
  bufferToPdf() {
    console.log("Entrando al buffertoPDF")
    // Paso 1: Convierte el Buffer a una cadena en base64
    var buf =[
      49,
      50,
      56,
      101,
      102,
      98,
      55,
      56,
      101,
      101,
      55,
      48,
      100,
      50,
      49,
      56,
      101,
      99,
      54,
      57,
      102,
      49,
      51,
      52,
      54,
      50,
      57,
      102,
      54,
      55,
      49,
      51,
      101,
      99,
      55,
      98,
      102,
      54,
      54,
      102,
      101,
      48,
      97,
      100,
      51,
      57,
      57,
      54,
      101,
      50,
      98,
      57,
      56,
      56,
      49,
      97,
      101,
      101,
      57,
      102,
      52,
      56,
      57,
      101,
      52,
      53,
      48,
      56,
      101,
      50,
      97,
      51,
      55,
      102,
      51,
      102,
      51,
      48,
      56,
      54,
      57,
      51,
      50,
      97,
      50,
      102,
      102,
      51,
      101,
      52,
      52,
      53,
      57,
      53,
      101,
      57,
      49,
      57,
      50,
      55,
      53,
      100,
      48,
      49,
      101,
      97,
      49,
      97,
      54,
      48,
      54,
      51,
      51,
      52,
      48,
      48,
      56,
      99,
      99,
      55,
      99,
      54,
      52,
      51,
      51,
      53,
      57,
      97,
      56,
      57,
      51,
      101,
      51,
      56,
      97,
      53,
      99,
      54,
      54,
      53,
      53,
      51,
      48,
      100,
      97,
      56,
      102,
      56,
      55,
      52,
      57,
      48,
      55,
      99,
      100,
      100,
      48,
      100,
      51,
      53,
      49,
      97,
      57,
      99,
      52,
      57,
      54,
      56,
      51,
      55,
      49,
      52,
      54,
      52,
      53,
      51,
      54,
      51,
      52,
      49,
      102,
      101,
      97,
      97,
      101,
      98,
      50,
      48,
      57,
      54,
      53,
      102,
      97,
      55,
      53,
      98,
      102,
      51,
      52,
      97,
      55,
      99,
      51,
      55,
      49,
      98,
      48,
      56,
      98,
      50,
      51,
      53,
      98,
      97,
      48,
      53,
      56,
      52,
      53,
      48,
      52,
      53,
      54,
      97,
      57,
      101,
      48,
      48,
      48,
      97,
      54,
      55,
      50,
      100,
      97,
      56,
      52,
      50,
      55,
      99,
      101,
      100,
      100,
      57,
      50,
      51,
      48,
      97,
      97,
      100,
      99,
      48,
      52,
      97,
      102,
      98,
      56,
      102,
      48,
      52,
      99,
      55,
      56,
      100,
      54,
      54,
      50,
      56,
      98,
      102,
      101,
      53,
      52,
      49,
      51,
      55,
      100,
      55,
      99,
      100,
      99,
      49,
      52,
      49,
      53,
      53,
      98,
      53,
      97,
      53,
      52,
      99,
      98,
      57,
      52,
      50,
      53,
      51,
      52,
      55,
      55,
      57,
      54,
      57,
      100,
      50,
      55,
      49,
      50,
      97,
      50,
      102,
      97,
      55,
      56,
      101,
      54,
      51,
      53,
      97,
      54,
      51,
      50,
      57,
      54,
      97,
      48,
      50,
      97,
      98,
      100,
      98,
      49,
      98,
      101,
      56,
      101,
      52,
      50,
      50,
      48,
      54,
      57,
      100,
      101,
      49,
      100,
      98,
      49,
      50,
      99,
      53,
      99,
      54,
      54,
      49,
      51,
      52,
      57,
      54,
      55,
      53,
      57,
      49,
      102,
      55,
      98,
      97,
      51,
      50,
      55,
      48,
      57,
      102,
      51,
      101,
      49,
      51,
      102,
      102,
      50,
      56,
      54,
      50,
      98,
      101,
      48,
      49,
      57,
      52,
      57,
      48,
      100,
      57,
      54,
      99,
      98,
      51,
      99,
      99,
      101,
      48,
      99,
      101,
      52,
      48,
      98,
      50,
      49,
      53,
      51,
      53,
      52,
      52,
      49,
      55,
      49,
      55,
      52,
      101,
      56,
      100,
      48,
      49,
      56,
      100,
      98,
      100,
      102,
      57,
      100,
      56,
      49,
      52,
      48,
      49,
      50,
      54,
      55,
      98,
      57,
      97,
      97,
      48,
      52,
      54,
      53,
      49,
      99,
      51,
      53,
      54,
      102,
      50,
      48,
      52,
      54,
      51,
      102,
      54,
      50,
      99,
      52,
      56,
      54,
      48,
      49,
      99,
      48,
      98,
      48,
      100,
      102,
      53,
      97,
      48,
      53,
      97,
      48,
      54,
      50,
      53,
      52,
      55,
      49,
      48,
      53,
      51,
      51,
      102,
      100,
      48,
      50,
      57,
      55,
      49,
      55,
      53,
      53,
      99,
      53,
      57,
      48,
      51,
      98,
      51,
      48,
      53,
      53,
      56,
      100,
      51,
      51,
      50,
      50,
      97,
      101,
      99,
      99,
      101,
      56,
      49,
      53,
      53,
      52,
      52,
      51,
      98,
      57,
      57,
      50,
      101,
      52,
      56,
      100,
      101,
      99,
      54,
      102,
      100,
      50,
      52,
      102,
      57,
      52,
      98,
      100,
      97,
      98,
      49,
      100,
      49,
      48,
      54,
      52,
      53,
      98,
      57,
      54,
      54,
      56,
      56,
      48,
      102,
      57,
      102,
      49,
      49,
      101,
      97,
      54,
      100,
      50,
      52,
      97,
      50,
      54,
      55,
      53,
      50,
      98,
      102,
      99,
      51,
      56,
      57,
      98,
      55,
      52,
      101,
      98,
      51,
      52,
      102,
      56,
      52,
      102,
      56,
      49,
      52,
      56,
      55,
      102,
      52,
      50,
      100,
      57,
      101,
      56,
      97,
      54,
      55,
      57,
      56,
      57,
      101,
      97,
      99,
      52,
      98,
      48,
      55,
      56,
      102,
      56,
      57,
      102,
      101,
      50,
      56,
      56,
      53,
      97,
      50,
      99,
      48,
      100,
      50,
      54,
      56,
      55,
      53,
      51,
      54,
      54,
      97,
      97,
      51,
      98,
      97,
      97,
      52,
      98,
      102,
      51,
      99,
      48,
      100,
      98,
      50,
      101,
      56,
      49,
      50,
      99,
      101,
      52,
      57,
      102,
      102,
      52,
      99,
      50,
      54,
      51,
      102,
      54,
      52,
      53,
      101,
      98,
      56,
      52,
      51,
      53,
      55,
      51,
      100,
      56,
      54,
      55,
      101,
      51,
      52,
      53,
      99,
      99,
      49,
      50,
      98,
      54,
      101,
      56,
      57,
      48,
      97,
      48,
      52,
      50,
      57,
      99,
      98,
      56,
      49,
      54,
      101,
      98,
      49,
      51,
      57,
      97,
      55,
      53,
      55,
      55,
      98,
      51,
      100,
      57,
      54,
      102,
      53,
      98,
      57,
      48,
      97,
      54,
      98,
      52,
      98,
      57,
      101,
      101,
      100,
      100,
      55,
      53,
      100,
      100,
      57,
      57,
      57,
      50,
      102,
      49,
      49,
      98,
      54,
      49,
      54,
      50,
      97,
      48,
      51,
      99,
      99,
      49,
      52,
      100,
      57,
      57,
      51,
      56,
      102,
      100,
      100,
      101,
      57,
      99,
      97,
      101,
      52,
      102,
      98,
      99,
      98,
      53,
      54,
      51,
      48,
      51,
      55,
      55,
      98,
      50,
      52,
      98,
      51,
      50,
      100,
      51,
      56,
      101,
      55,
      101,
      50,
      49,
      56,
      52,
      48,
      49,
      55,
      50,
      98,
      48,
      99,
      53,
      102,
      54,
      102,
      101,
      101,
      101,
      98,
      50,
      51,
      50,
      53,
      52,
      49,
      99,
      52,
      49,
      102,
      50,
      50,
      53,
      99,
      101,
      52,
      52,
      54,
      57,
      100,
      56,
      98,
      98,
      98,
      52,
      55,
      50,
      51,
      101,
      55,
      102,
      97,
      100,
      101,
      53,
      102,
      55,
      52,
      48,
      49,
      53,
      97,
      52,
      97,
      98,
      53,
      100,
      98,
      52,
      56,
      56,
      56,
      97,
      52,
      54,
      57,
      98,
      57,
      53,
      57,
      97,
      55,
      51,
      52,
      55,
      56,
      50,
      99,
      101,
      48,
      51,
      99,
      54,
      51,
      57,
      48,
      52,
      57,
      51,
      98,
      52,
      102,
      51,
      51,
      49,
      54,
      101,
      101,
      51,
      101,
      54,
      99,
      50,
      100,
      57,
      102,
      53,
      99,
      56,
      51,
      48,
      50,
      57,
      99,
      97,
      49,
      56,
      54,
      51,
      98,
      52,
      57,
      101,
      97,
      98,
      52,
      49,
      102,
      98,
      57,
      57,
      99,
      52,
      57,
      51,
      53,
      97,
      54,
      54,
      98,
      48,
      101,
      54,
      99,
      51,
      54,
      50,
      48,
      57,
      99,
      56,
      53,
      99,
      101,
      55,
      51,
      97,
      102,
      56,
      53,
      53,
      51,
      102,
      51,
      56,
      99,
      101,
      50,
      99,
      102,
      54,
      97,
      49,
      54,
      52,
      48,
      54,
      99,
      99,
      53,
      55,
      54,
      48,
      98,
      52,
      101,
      98,
      50,
      51,
      97,
      97,
      101,
      102,
      97,
      102,
      97,
      101,
      52,
      97,
      56,
      99,
      54,
      97,
      100,
      55,
      54,
      102,
      53,
      101,
      101,
      102,
      51,
      49,
      48,
      98,
      56,
      52,
      57,
      57,
      54,
      97,
      100,
      97,
      56,
      97,
      51,
      51,
      54,
      101,
      48,
      102,
      98,
      101,
      100,
      97,
      54,
      49,
      97,
      100,
      57,
      48,
      56,
      56,
      54,
      49,
      102,
      51,
      97,
      99,
      100,
      50,
      53,
      50,
      101,
      54,
      54,
      98,
      48,
      99,
      100,
      51,
      54,
      50,
      51,
      100,
      57,
      99,
      48,
      56,
      102,
      97,
      101,
      53,
      55,
      53,
      102,
      48,
      57,
      98,
      50,
      102,
      97,
      101,
      97,
      50,
      51,
      101,
      54,
      98,
      97,
      48,
      53,
      97,
      56,
      98,
      57,
      101,
      56,
      48,
      51,
      100,
      97,
      49,
      54,
      102,
      97,
      57,
      100,
      57,
      53,
      53,
      54,
      52,
      57,
      100,
      51,
      51,
      49,
      50,
      51,
      48,
      50,
      99,
      49,
      101,
      97,
      99,
      49,
      57,
      97,
      56,
      55,
      101,
      100,
      48,
      51,
      102,
      54,
      99,
      55,
      53,
      55,
      97,
      56,
      57,
      52,
      54,
      49,
      99,
      53,
      101,
      100,
      51,
      98,
      51,
      53,
      100,
      50,
      53,
      50,
      98,
      54,
      51,
      52,
      100,
      52,
      51,
      55,
      98,
      54,
      97,
      52,
      99,
      49,
      49,
      55,
      49,
      100,
      101,
      55,
      53,
      52,
      48,
      54,
      54,
      51,
      49,
      57,
      49,
      53,
      97,
      51,
      50,
      51,
      51,
      97,
      101,
      52,
      52,
      51,
      56,
      51,
      56,
      100,
      100,
      98,
      52,
      57,
      98,
      52,
      52,
      56,
      102,
      51,
      55,
      48,
      57,
      101,
      102,
      55,
      50,
      52,
      97,
      52,
      98,
      54,
      100,
      49,
      48,
      99,
      49,
      48,
      49,
      53,
      49,
      100,
      56,
      57,
      98,
      57,
      55,
      102,
      101,
      101,
      98,
      55,
      56,
      101,
      97,
      56,
      97,
      56,
      101,
      101,
      57,
      100,
      50,
      52,
      53,
      49,
      48,
      101,
      51,
      49,
      57,
      97,
      50,
      101,
      55,
      54,
      57,
      51,
      102,
      98,
      100,
      99,
      100,
      100,
      49,
      49,
      50,
      97,
      99,
      52,
      102,
      55,
      54,
      102,
      100,
      55,
      102,
      100,
      99,
      97,
      48,
      56,
      51,
      55,
      53,
      102,
      51,
      57,
      54,
      100,
      56,
      98,
      52,
      98,
      57,
      98,
      99,
      101,
      100,
      48,
      51,
      56,
      55,
      48,
      97,
      51,
      52,
      99,
      50,
      54,
      99,
      53,
      100,
      50,
      102,
      99,
      97,
      50,
      100,
      99,
      52,
      102,
      54,
      57,
      52,
      50,
      49,
      100,
      56,
      98,
      57,
      99,
      54,
      57,
      55,
      101,
      56,
      57,
      48,
      48,
      50,
      101,
      55,
      97,
      98,
      100,
      55,
      51,
      55,
      52,
      57,
      57,
      53,
      53,
      51,
      49,
      55,
      48,
      101,
      54,
      97,
      54,
      57,
      55,
      55,
      50,
      57,
      53,
      57,
      97,
      101,
      49,
      100,
      102,
      50,
      54,
      53,
      97,
      49,
      57,
      99,
      102,
      102,
      51,
      97,
      97,
      48,
      56,
      102,
      48,
      102,
      49,
      100,
      98,
      49,
      53,
      98,
      54,
      100,
      51,
      98,
      98,
      97,
      97,
      102,
      49,
      55,
      102,
      51,
      48,
      101,
      101,
      102,
      54,
      100,
      102,
      101,
      52,
      48,
      98,
      51,
      57,
      98,
      101,
      98,
      98,
      48,
      98,
      49,
      57,
      48,
      53,
      101,
      48,
      57,
      102,
      53,
      53,
      51,
      55,
      98,
      100,
      102,
      98,
      102,
      50,
      50,
      50,
      49,
      99,
      97,
      51,
      100,
      55,
      51,
      99,
      99,
      100,
      55,
      100,
      50,
      48,
      50,
      51,
      55,
      102,
      50,
      55,
      101,
      57,
      52,
      57,
      53,
      49,
      49,
      52,
      57,
      54,
      55,
      49,
      99,
      48,
      97,
      100,
      102,
      100,
      101,
      48,
      98,
      55,
      57,
      53,
      97,
      51,
      98,
      97,
      98,
      101,
      54,
      98,
      49,
      54,
      102,
      102,
      48,
      51,
      50,
      98,
      97,
      102,
      48,
      49,
      48,
      99,
      55,
      55,
      56,
      49,
      48,
      48,
      53,
      50,
      98,
      99,
      50,
      52,
      55,
      52,
      101,
      57,
      55,
      52,
      53,
      57,
      52,
      101,
      53,
      97,
      53,
      99,
      102,
      57,
      100,
      101,
      48,
      101,
      48,
      50,
      97,
      52,
      48,
      55,
      51,
      101,
      52,
      53,
      52,
      50,
      52,
      97,
      98,
      57,
      100,
      100,
      100,
      50,
      57,
      98,
      101,
      49,
      54,
      57,
      97,
      53,
      98,
      100,
      97,
      53,
      101,
      48,
      48,
      98,
      49,
      53,
      51,
      98,
      101,
      101,
      56,
      57,
      54,
      97,
      100,
      55,
      49,
      56,
      56,
      51,
      54,
      57,
      102,
      99,
      102,
      56,
      49,
      54,
      53,
      56,
      54,
      54,
      55,
      49,
      97,
      98,
      54,
      55,
      48,
      52,
      53,
      99,
      54,
      99,
      52,
      101,
      50,
      55,
      57,
      55,
      100,
      97,
      52,
      101,
      52,
      102,
      54,
      48,
      102,
      53,
      53,
      51,
      50,
      48,
      48,
      52,
      98,
      102,
      56,
      97,
      48,
      49,
      100,
      55,
      49,
      98,
      50,
      54,
      51,
      101,
      52,
      51,
      98,
      48,
      99,
      97,
      56,
      53,
      51,
      98,
      51,
      97,
      55,
      54,
      51,
      98,
      100,
      55,
      98,
      51,
      48,
      54,
      97,
      48,
      100,
      99,
      57,
      54,
      101,
      101,
      51,
      48,
      52,
      53,
      102,
      52,
      102,
      102,
      57,
      57,
      56,
      49,
      51,
      98,
      50,
      56,
      101,
      53,
      101,
      99,
      49,
      56,
      51,
      49,
      53,
      101,
      101,
      54,
      53,
      54,
      51,
      51,
      52,
      98,
      102,
      101,
      51,
      102,
      97,
      100,
      52,
      53,
      51,
      49,
      53,
      100,
      101,
      98,
      101,
      97,
      51,
      53,
      97,
      102,
      50,
      97,
      100,
      49,
      48,
      54,
      97,
      54,
      54,
      50,
      102,
      101,
      54,
      102,
      54,
      50,
      49,
      48,
      101,
      53,
      97,
      52,
      99,
      52,
      54,
      52,
      54,
      56,
      53,
      101,
      100,
      97,
      102,
      97,
      101,
      56,
      54,
      50,
      54,
      98,
      99,
      57,
      97,
      101,
      52,
      50,
      56,
      101,
      57,
      53,
      48,
      100,
      98,
      100,
      52,
      100,
      97,
      100,
      53,
      50,
      52,
      98,
      53,
      48,
      56,
      97,
      101,
      52,
      98,
      102,
      48,
      52,
      101,
      53,
      98,
      49,
      56,
      53,
      48,
      54,
      50,
      99,
      102,
      52,
      102,
      49,
      98,
      57,
      102,
      52,
      56,
      54,
      101,
      56,
      51,
      98,
      54,
      101,
      48,
      57,
      100,
      54,
      54,
      52,
      98,
      55,
      57,
      102,
      100,
      49,
      49,
      56,
      50,
      57,
      100,
      55,
      52,
      52,
      48,
      100,
      54,
      49,
      52,
      53,
      52,
      50,
      50,
      49,
      51,
      56,
      101,
      102,
      56,
      101,
      51,
      55,
      51,
      98,
      49,
      52,
      98,
      102,
      49,
      57,
      101,
      52,
      48,
      50,
      55,
      97,
      51,
      57,
      51,
      49,
      49,
      100,
      52,
      51,
      99,
      53,
      48,
      50,
      56,
      99,
      53,
      97,
      100,
      98,
      48,
      101,
      99,
      57,
      51,
      55,
      100,
      50,
      49,
      53,
      55,
      51,
      57,
      53,
      55,
      52,
      99,
      97,
      99,
      99,
      51,
      53,
      49,
      57,
      97,
      53,
      48,
      98,
      97,
      53,
      52,
      100,
      55,
      99,
      102,
      102,
      97,
      48,
      97,
      101,
      102,
      50,
      99,
      97,
      56,
      99,
      55,
      102,
      102,
      48,
      56,
      56,
      51,
      98,
      49,
      52,
      50,
      50,
      53,
      52,
      50,
      56,
      54,
      49,
      97,
      51,
      49,
      49,
      97,
      56,
      56,
      48,
      56,
      100,
      100,
      52,
      98,
      50,
      102,
      102,
      101,
      55,
      48,
      99,
      52,
      102,
      97,
      53,
      102,
      98,
      100,
      97,
      52,
      57,
      99,
      50,
      49,
      56,
      99,
      57,
      52,
      49,
      50,
      53,
      99,
      97,
      99,
      102,
      52,
      97,
      101,
      98,
      52,
      97,
      54,
      52,
      51,
      101,
      98,
      101,
      50,
      48,
      99,
      55,
      56,
      48,
      98,
      55,
      55,
      98,
      53,
      57,
      98,
      55,
      54,
      51,
      101,
      53,
      57,
      51,
      57,
      49,
      54,
      56,
      51,
      100,
      51,
      49,
      98,
      49,
      99,
      50,
      99,
      53,
      99,
      50,
      99,
      55,
      49,
      53,
      52,
      57,
      98,
      49,
      55,
      52,
      51,
      52,
      54,
      102,
      56,
      51,
      48,
      98,
      51,
      97,
      52,
      101,
      52,
      101,
      55,
      51,
      98,
      98,
      55,
      52,
      55,
      100,
      57,
      101,
      55,
      53,
      51,
      56,
      49,
      53,
      52,
      98,
      102,
      48,
      56,
      55,
      49,
      53,
      98,
      53,
      54,
      56,
      57,
      57,
      97,
      49,
      50,
      98,
      54,
      50,
      54,
      97,
      52,
      53,
      101,
      49,
      54,
      98,
      56,
      98,
      102,
      99,
      54,
      56,
      102,
      54,
      49,
      101,
      57,
      48,
      53,
      50,
      57,
      51,
      100,
      55,
      52,
      98,
      57,
      56,
      50,
      57,
      98,
      52,
      55,
      55,
      48,
      54,
      50,
      54,
      57,
      97,
      100,
      53,
      101,
      98,
      97,
      54,
      101,
      48,
      56,
      57,
      98,
      100,
      56,
      101,
      100,
      55,
      99,
      49,
      97,
      52,
      101,
      100,
      100,
      52,
      54,
      100,
      49,
      97,
      50,
      50,
      49,
      56,
      55,
      54,
      51,
      56,
      48,
      56,
      49,
      53,
      53,
      97,
      55,
      51,
      57,
      50,
      98,
      54,
      51,
      50,
      57,
      97,
      57,
      57,
      50,
      49,
      100,
      102,
      100,
      97,
      100,
      99,
      57,
      51,
      102,
      56,
      102,
      48,
      51,
      99,
      54,
      53,
      51,
      51,
      102,
      53,
      99,
      48,
      97,
      52,
      100,
      100,
      101,
      99,
      50,
      54,
      53,
      97,
      51,
      99,
      101,
      51,
      51,
      98,
      99,
      51,
      97,
      98,
      56,
      100,
      101,
      55,
      52,
      98,
      54,
      56,
      50,
      49,
      97,
      53,
      48,
      49,
      97,
      56,
      54,
      52,
      98,
      49,
      102,
      53,
      53,
      50,
      48,
      97,
      54,
      101,
      97,
      55,
      101,
      52,
      51,
      54,
      101,
      101,
      53,
      102,
      102,
      101,
      48,
      102,
      101,
      56,
      97,
      99,
      100,
      53,
      97,
      102,
      50,
      54,
      56,
      56,
      55,
      100,
      52,
      102,
      99,
      100,
      100,
      99,
      97,
      52,
      101,
      48,
      98,
      101,
      102,
      48,
      98,
      97,
      102,
      55,
      98,
      102,
      56,
      97,
      48,
      57,
      51,
      101,
      52,
      98,
      50,
      54,
      52,
      102,
      52,
      54,
      99,
      55,
      49,
      54,
      56,
      98,
      98,
      56,
      56,
      99,
      102,
      99,
      102,
      98,
      54,
      53,
      98,
      54,
      56,
      51,
      51,
      53,
      99,
      51,
      56,
      101,
      56,
      100,
      50,
      102,
      54,
      57,
      49,
      98,
      56,
      51,
      52,
      101,
      50,
      52,
      98,
      51,
      101,
      53,
      97,
      97,
      52,
      57,
      48,
      48,
      53,
      98,
      100,
      56,
      102,
      53,
      99,
      56,
      55,
      50,
      53,
      101,
      101,
      48,
      50,
      57,
      98,
      55,
      48,
      54,
      100,
      55,
      52,
      51,
      98,
      49,
      57,
      48,
      101,
      57,
      50,
      98,
      55,
      98,
      51,
      51,
      101,
      53,
      52,
      99,
      56,
      55,
      57,
      53,
      100,
      52,
      97,
      52,
      49,
      102,
      99,
      53,
      54,
      54,
      56,
      57,
      51,
      102,
      51,
      56,
      51,
      53,
      97,
      52,
      50,
      98,
      97,
      57,
      56,
      97,
      57,
      56,
      101,
      101,
      97,
      51,
      100,
      57,
      56,
      102,
      100,
      55,
      52,
      101,
      52,
      55,
      99,
      52,
      52,
      51,
      52,
      57,
      55,
      55,
      100,
      48,
      48,
      99,
      49,
      48,
      98,
      57,
      57,
      101,
      97,
      54,
      54,
      57,
      53,
      52,
      55,
      98,
      102,
      49,
      98,
      101,
      49,
      101,
      55,
      99,
      99,
      56,
      57,
      49,
      99,
      49,
      99,
      48,
      98,
      98,
      57,
      49,
      48,
      54,
      55,
      48,
      100,
      52,
      55,
      55,
      54,
      55,
      101,
      99,
      48,
      102,
      55,
      49,
      54,
      49,
      102,
      101,
      50,
      50,
      98,
      98,
      97,
      54,
      100,
      54,
      51,
      97,
      99,
      102,
      101,
      48,
      101,
      101,
      56,
      99,
      50,
      49,
      49,
      51,
      54,
      48,
      54,
      101,
      101,
      53,
      56,
      100,
      97,
      97,
      97,
      102,
      99,
      101,
      54,
      56,
      98,
      56,
      49,
      51,
      52,
      98,
      48,
      54,
      53,
      98,
      100,
      100,
      54,
      49,
      57,
      57,
      51,
      98,
      57,
      50,
      49,
      101,
      49,
      98,
      55,
      55,
      51,
      97,
      99,
      100,
      97,
      48,
      100,
      52,
      56,
      54,
      56,
      48,
      48,
      48,
      99,
      55,
      48,
      102,
      50,
      51,
      102,
      51,
      99,
      98,
      49,
      51,
      50,
      53,
      53,
      100,
      52,
      97,
      57,
      50,
      97,
      99,
      53,
      53,
      98,
      99,
      98,
      48,
      54,
      52,
      97,
      101,
      56,
      49,
      55,
      57,
      100,
      48,
      49,
      100,
      55,
      101,
      48,
      48,
      49,
      51,
      54,
      51,
      97,
      99,
      51,
      102,
      100,
      100,
      48,
      52,
      53,
      52,
      102,
      97,
      57,
      50,
      50,
      97,
      54,
      54,
      52,
      52,
      101,
      102,
      53,
      98,
      49,
      99,
      51,
      52,
      49,
      98,
      50,
      102,
      55,
      101,
      53,
      54,
      56,
      56,
      55,
      100,
      100,
      50,
      49,
      51,
      55,
      52,
      55,
      55,
      102,
      57,
      48,
      97,
      101,
      49,
      48,
      50,
      55,
      98,
      102,
      98,
      55,
      51,
      55,
      48,
      98,
      100,
      48,
      51,
      100,
      102,
      56,
      100,
      54,
      52,
      99,
      98,
      54,
      98,
      49,
      98,
      102,
      101,
      49,
      99,
      49,
      57,
      51,
      97,
      56,
      99,
      48,
      56,
      49,
      48,
      56,
      49,
      50,
      50,
      52,
      54,
      102,
      57,
      50,
      53,
      56,
      49,
      57,
      51,
      99,
      53,
      56,
      99,
      57,
      56,
      102,
      102,
      50,
      53,
      99,
      57,
      56,
      102,
      99,
      54,
      52,
      50,
      52,
      56,
      56,
      49,
      48,
      102,
      97,
      48,
      48,
      102,
      53,
      49,
      102,
      51,
      52,
      97,
      51,
      100,
      54,
      57,
      56,
      52,
      99,
      98,
      56,
      98,
      55,
      101,
      99,
      48,
      49,
      102,
      49,
      51,
      99,
      48,
      101,
      50,
      102,
      98,
      99,
      50,
      50,
      53,
      51,
      99,
      100,
      52,
      53,
      54,
      99,
      102,
      97,
      56,
      98,
      102,
      57,
      57,
      57,
      97,
      49,
      100,
      98,
      54,
      102,
      50,
      52,
      57,
      99,
      49,
      53,
      52,
      49,
      102,
      48,
      99,
      50,
      51,
      48,
      100,
      48,
      49,
      99,
      101,
      100,
      102,
      100,
      98,
      57,
      51,
      49,
      57,
      49,
      97,
      51,
      98,
      55,
      97,
      100,
      102,
      55,
      97,
      49,
      49,
      98,
      100,
      102,
      56,
      50,
      57,
      99,
      49,
      48,
      51,
      56,
      52,
      97,
      54,
      51,
      48,
      56,
      97,
      98,
      56,
      98,
      97,
      98,
      53,
      98,
      51,
      97,
      97,
      100,
      98,
      50,
      100,
      97,
      49,
      99,
      54,
      56,
      52,
      57,
      102,
      53,
      100,
      55,
      99,
      97,
      56,
      100,
      100,
      97,
      102,
      53,
      53,
      52,
      49,
      48,
      50,
      99,
      51,
      51,
      101,
      55,
      101,
      53,
      99,
      97,
      99,
      101,
      102,
      100,
      54,
      48,
      57,
      50,
      97,
      48,
      102,
      52,
      56,
      51,
      101,
      50,
      48,
      49,
      101,
      54,
      102,
      54,
      51,
      53,
      54,
      48,
      101,
      57,
      49,
      50,
      48,
      56,
      102,
      101,
      51,
      56,
      101,
      50,
      101,
      99,
      99,
      97,
      52,
      53,
      57,
      54,
      48,
      55,
      101,
      53,
      48,
      101,
      98,
      56,
      98,
      55,
      50,
      50,
      99,
      49,
      100,
      54,
      56,
      98,
      98,
      100,
      54,
      56,
      51,
      99,
      99,
      56,
      53,
      56,
      56,
      51,
      102,
      54,
      57,
      50,
      57,
      57,
      98,
      49,
      100,
      49,
      54,
      100,
      97,
      101,
      101,
      50,
      97,
      102,
      55,
      99,
      101,
      102,
      56,
      49,
      55,
      56,
      48,
      98,
      53,
      57,
      54,
      97,
      100,
      53,
      50,
      48,
      54,
      50,
      102,
      50,
      50,
      99,
      55,
      51,
      49,
      98,
      54,
      57,
      48,
      52,
      49,
      54,
      55,
      99,
      102,
      52,
      98,
      56,
      99,
      48,
      55,
      100,
      51,
      102,
      49,
      57,
      99,
      53,
      53,
      99,
      100,
      98,
      102,
      101,
      101,
      55,
      100,
      54,
      97,
      50,
      100,
      54,
      55,
      57,
      50,
      51,
      51,
      102,
      101,
      99,
      99,
      97,
      48,
      57,
      98,
      56,
      49,
      101,
      98,
      49,
      57,
      57,
      52,
      53,
      55,
      51,
      50,
      102,
      48,
      100,
      54,
      56,
      54,
      55,
      52,
      48,
      53,
      51,
      55,
      51,
      51,
      56,
      100,
      101,
      51,
      98,
      53,
      54,
      50,
      57,
      102,
      97,
      49,
      49,
      52,
      57,
      102,
      57,
      50,
      48,
      99,
      56,
      57,
      49,
      54,
      98,
      102,
      54,
      49,
      97,
      51,
      101,
      97,
      56,
      98,
      56,
      57,
      55,
      52,
      49,
      56,
      57,
      51,
      57,
      52,
      52,
      100,
      102,
      100,
      100,
      56,
      48,
      98,
      55,
      51,
      99,
      102,
      102,
      57,
      102,
      54,
      50,
      52,
      54,
      100,
      56,
      55,
      97,
      55,
      53,
      55,
      97,
      57,
      55,
      100,
      56,
      54,
      97,
      49,
      101,
      100,
      49,
      54,
      100,
      51,
      57,
      53,
      48,
      49,
      97,
      50,
      102,
      97,
      53,
      57,
      98,
      53,
      51,
      102,
      50,
      98,
      102,
      49,
      50,
      50,
      52,
      52,
      102,
      48,
      53,
      54,
      49,
      57,
      50,
      48,
      57,
      48,
      49,
      55,
      98,
      100,
      50,
      97,
      100,
      50,
      57,
      48,
      100,
      55,
      50,
      97,
      101,
      102,
      49,
      101,
      52,
      97,
      54,
      52,
      99,
      98,
      102,
      48,
      52,
      51,
      52,
      51,
      48,
      100,
      52,
      52,
      57,
      100,
      48,
      54,
      54,
      55,
      100,
      48,
      57,
      55,
      56,
      98,
      49,
      48,
      101,
      51,
      102,
      102,
      97,
      99,
      51,
      51,
      52,
      50,
      55,
      56,
      100,
      99,
      101,
      48,
      98,
      51,
      102,
      53,
      99,
      51,
      57,
      100,
      98,
      48,
      49,
      55,
      101,
      48,
      102,
      54,
      54,
      52,
      97,
      53,
      52,
      101,
      50,
      52,
      55,
      53,
      49,
      54,
      97,
      56,
      98,
      49,
      56,
      97,
      48,
      57,
      100,
      57,
      50,
      56
    ]
 
    const base64String = btoa(
      String.fromCharCode.apply(null, Array.from(new Uint8Array(buf)))
    );
    const link = document.createElement('a');
    link.href = 'data:image/png;base64,' + base64String;
  
    // Asigna un nombre de archivo para la descarga
    link.download = "aa";
  
    // Simula un clic en el enlace para iniciar la descarga
    link.click();
  }
}

   